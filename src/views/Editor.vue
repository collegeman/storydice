<template>
  <div class="editor">
    <svg width="100%" height="100%" viewBox="0 0 612 792" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <title>Template</title>
      <desc>Created with Sketch.</desc>
      <g id="Template" stroke="none" stroke-width="1" fill-rule="evenodd">
        <g id="Die" transform="translate(40.000000, 78.000000)">
          <g id="Flaps" fill="#ECF0F1">
            <path d="M191,0 L341,0 L341,40 L191,40 L191,0 Z" id="Flap"></path>
            <path d="M151,40 L191,40 L191,190 L151,190 L151,40 Z" id="Flap"></path>
            <path d="M151,341 L191,341 L191,490 L151,490 L151,341 Z" id="Flap"></path>
            <path d="M0,190 L40,190 L40,340 L0,340 L0,190 Z" id="Flap"></path>
            <path d="M493,190 L533,190 L533,340 L493,340 L493,190 Z" id="Flap"></path>
            <path d="M341,40 L381,40 L381,190 L341,190 L341,40 Z" id="Flap"></path>
            <path d="M342,341 L382,341 L382,490 L342,490 L342,341 Z" id="Flap"></path>
          </g>
          <g id="Sides" transform="translate(66.000000, 66.000000)">
            <g id="Side1" transform="translate(151.000000, 0.000000)">
              <g id="Shape1" v-html="svg0" @click.prevent="showPickerFor(0)">
                <rect id="Placeholder" x="0" y="0" width="100" height="100"></rect>
              </g>
            </g>
            <g id="Side2" transform="translate(151.000000, 149.000000)">
              <g id="Shape2" v-html="svg1" @click.prevent="showPickerFor(1)">
                <rect id="Placeholder" x="0" y="0" width="100" height="100"></rect>
              </g>
            </g>
            <g id="Side3" transform="translate(0.000000, 149.000000)">
              <g id="Shape3" v-html="svg2" @click.prevent="showPickerFor(2)">
                <rect id="Placeholder" x="0" y="0" width="100" height="100"></rect>
              </g>
            </g>
            <g id="Side4" transform="translate(302.000000, 149.000000)">
              <g id="Shape4" v-html="svg3" @click.prevent="showPickerFor(3)">
                <rect id="Placeholder" x="0" y="0" width="100" height="100"></rect>
              </g>
            </g>
            <g id="Side5" transform="translate(151.000000, 300.000000)">
              <g id="Shape5" v-html="svg4" @click.prevent="showPickerFor(4)">
                <rect id="Placeholder" x="0" y="0" width="100" height="100"></rect>
              </g>
            </g>
            <g id="Side6" transform="translate(151.000000, 451.000000)">
              <g id="Shape6" v-html="svg5" @click.prevent="showPickerFor(5)">
                <rect id="Placeholder" x="0" y="0" width="100" height="100"></rect>
              </g>
            </g>
          </g>
          <g id="Outlines" transform="translate(39.500000, 40.000000)" stroke="#EFEFEF" stroke-linecap="square">
            <line x1="1" y1="299.5" x2="454" y2="299.5" id="Line"></line>
            <line x1="151" y1="0.5" x2="151" y2="602.5" id="Line-2"></line>
            <line x1="302" y1="0.5" x2="302" y2="602.5" id="Line-3"></line>
            <line x1="0" y1="150.5" x2="454" y2="150.5" id="Line"></line>
            <line x1="151" y1="602.5" x2="302" y2="602.5" id="Line-4"></line>
            <line x1="151" y1="449.5" x2="302" y2="449.5" id="Line-4"></line>
          </g>
          <g id="Cutlines" stroke="#979797" stroke-dasharray="5" stroke-linecap="square" stroke-width="2">
            <line x1="0.5" y1="190.5" x2="190" y2="191" id="Line-5"></line>
            <line x1="345.5" y1="190.5" x2="533.5" y2="190.5" id="Line-6"></line>
            <line x1="0.5" y1="191.5" x2="0.5" y2="339.5" id="Line-7"></line>
            <line x1="0.5" y1="339.5" x2="190.5" y2="339.5" id="Line-8"></line>
            <line x1="151.5" y1="339.5" x2="151" y2="488" id="Line-9"></line>
            <line x1="151.5" y1="489.5" x2="191.5" y2="489.5" id="Line-10"></line>
            <line x1="190.5" y1="490.5" x2="191" y2="643" id="Line-11"></line>
            <line x1="194.5" y1="642.5" x2="341.5" y2="643.5" id="Line-12"></line>
            <line x1="342.5" y1="642.5" x2="341.5" y2="489.5" id="Line-13"></line>
            <line x1="345.5" y1="489.5" x2="381.5" y2="489.5" id="Line-14"></line>
            <line x1="381.5" y1="486.5" x2="381.5" y2="341.5" id="Line-15"></line>
            <line x1="342.5" y1="339.5" x2="533.5" y2="341.5" id="Line-16"></line>
            <line x1="533.5" y1="339.5" x2="533.5" y2="190.5" id="Line-17"></line>
            <line x1="151.5" y1="190.5" x2="151.5" y2="40.5" id="Line-18"></line>
            <line x1="151.5" y1="40.5" x2="190.5" y2="40.5" id="Line-19"></line>
            <line x1="191" y1="40" x2="191.5" y2="0.5" id="Line-20"></line>
            <line x1="191.5" y1="0.5" x2="341.5" y2="0.5" id="Line-21"></line>
            <line x1="341.5" y1="0.5" x2="341.5" y2="40.5" id="Line-22"></line>
            <line x1="345.5" y1="40.5" x2="382.5" y2="40.5" id="Line-23"></line>
            <line x1="381.5" y1="40.5" x2="381.5" y2="190.5" id="Line-24"></line>
          </g>
        </g>
      </g>
    </svg>

    <b-modal
      id="iconPicker"
      hide-header
      hide-footer
      @shown="$emit('pickerShown')"
    >
      <div class="scroller">
        <div
          v-if="!query"
        >
          <div
            v-for="group in ['smileys-emotion', 'animals-nature', 'food-drink', 'travel-places']"
            v-bind:key="group"
            class="mb-4"
          >
            <h3 class="h6 sticky-top bg-white pb-1">{{ group }}</h3>
            <b-container fluid>
              <b-row>
                <b-col
                  v-for="icon in library[group]"
                  v-bind:key="icon.hexcode"
                  cols="1"
                  class="p-0"
                >
                  <img :src="getUrl(icon.hexcode)" class="img-fluid" @click.prevent="pick(icon.hexcode)">
                </b-col>
              </b-row>
            </b-container>
          </div>
        </div>
        <div
          v-else
        >
          <h3 class="h6 sticky-top bg-white pb-1">search results</h3>
          <b-container fluid>
            <b-row>
              <b-col
                v-for="icon in results"
                v-bind:key="icon.ref"
                cols="1"
                class="p-0"
              >
                <img :src="getUrl(icon.ref)" class="img-fluid" @click.prevent="pick(icon.ref)">
              </b-col>
            </b-row>
          </b-container>
        </div>
      </div>
      <hr>
      <b-button variant="white" @click.prevent="$bvModal.hide('iconPicker')">
        Cancel
      </b-button>
      <b-container fluid class="search">
        <b-input v-model="query"></b-input>
      </b-container>
    </b-modal>
  </div>
</template>

<style lang="scss">
.editor {
  display: block;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 90vh;
  text-align: center;
}

#iconPicker {
  .modal-body {
    position: relative;
  }
  .scroller {
    height: 50vh;
    overflow: scroll;
    padding-top: 50px;
  }
  .search {
    position: absolute;
    left: 0;
    right: 0;
    top: 15px;
    background-color: white;
    padding-bottom: 15px;
  }
}

#shape1, #shape2, #shape3, #shape4, #shape5, #shape6 {
  cursor: pointer;
}
</style>

<script>
import { svg, getUrl, library, index, defaultIcon } from '@/utils'
import { debounce, slice } from 'lodash'

export default {
  props: {
    icons: {
      type: String,
      default: ''
    }
  },
  data () {
    return {
      setOnPick: null,
      svg0: '',
      svg1: '',
      svg2: '',
      svg3: '',
      svg4: '',
      svg5: '',
      library,
      getUrl,
      query: '',
      results: []
    }
  },
  watch: {
    icons () {
      this.updateIcons(this.iconList)
    },
    query: debounce(function() {
      if (this.query) {
        this.results = slice(index.search(this.query), 0, 50)
      } else {
        this.results = []
      }
    }, 100)
  },
  computed: {
    iconList() {
      return this.icons.split(',')
    }
  },
  async mounted () {
    window.__sharethis__ = null
    this.updateIcons(this.icons.split(','))
  },
  methods: {
    async updateIcons (icons) {
      // console.log(icons)
      for(let i = 0; i < 6; i++) {
        let xml = icons[i] ? await svg(icons[i]) : await svg(defaultIcon)
        this[`svg${i}`] = xml
      }
    },
    showPickerFor (setOnPick) {
      this.$emit('pickerOpening')
      this.$nextTick(() => {
        this.setOnPick = setOnPick
        this.$bvModal.show('iconPicker')
      })
    },
    pick (id) {
      let list = this.iconList
      list[this.setOnPick] = id
      this.$bvModal.hide('iconPicker')
      this.$router.push({ name: 'Editor', params: { icons: list.join(',') }})
    }
  }
}
</script>